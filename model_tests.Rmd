---
title: "Model Comparison"
author: "Ellen Wei"
date: "2024-06-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Imports
```{r}
library(mlrMBO)
library(lhs)
```

1. Define objective function and its parameters using the package smoof.
  Cosine mixture function (1D), Branin (2D), Hartmann(6D)
  
2. Generate initial design (optional).
  LHS, Random, Uniform
  
3. Define mlr learner for surrogate model (optional).
  Kriging (default), Random Forest
  
4. Set up a MBO control object.

5. Start the optimization with run=mbo().

6. Visualize runs: exampleRun, plotExampleRun

## General function

```{r}
# seperately generate obj.fun, surr.km (use makeLearner), des (LHS, random, uniform)


generate_model <- function(obj.fun, des, surr.km, control.iters=10, control.crit){
  # Generates model but doesn't run or visualize
  # obj.fun: objective function ex. makeBraninFunction()
  # des required variables:
    # n: number of initial points
    # fun: initial design function ex. lhs::randomLHS
  # surr.km: surrogate model ex. makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE))
  
  # control: infill criteria
    # control.iters
    # control.crit: infill criteria ex. makeMBOInfillCritEI()
  
  #des = generateDesign(des.n, par.set = getParamSet(obj.fun), des.fun)
  des$y = apply(des, 1, obj.fun)
  control = makeMBOControl()
  control = setMBOControlTermination(control, iters = control.iters)
  control = setMBOControlInfill(control, crit = control.crit)
  
  return(list(obj.fun=obj.fun, learner=surr.km, des=des, control=control))
}


run_model <- function(obj.fun, design, learner, control, show.info=FALSE, multi_iters= c(1L, 2L, 10L), pause=FALSE){
  # Runs model for _ iterations and displays plots
  
  run = exampleRun(fun=obj.fun, design=design, learner=learner, control=control, show.info, points.per.dim)
  plotExampleRun(run, iters=multi_iters, pause)
  
  return(run)
}

run_model <- function(obj.fun, design, learner, control, show.info=FALSE, multi_iters= c(1L, 2L, 10L), pause=FALSE, points.per.dim=50) {
  # Runs model for _ iterations and displays plots
  
  run = exampleRun(fun=obj.fun, design=design, learner=learner, control=control, show.info=show.info, points.per.dim=points.per.dim)
  plotExampleRun(run, iters=multi_iters, pause=pause)
  
  return(run)
} 

get_results <- function(run){
  return(as.data.frame(run$mbo.res$opt.path))
}

get_best <- function(run){
  return(run$mbo.res$best.ind)
}
```

# Table 1: Kriging+Cosine Mixture Function (1D)

## 1. EI, Random

```{r}
obj.fun = makeCosineMixtureFunction(1)
obj.fun = convertToMinimization(obj.fun)
print(autoplot(obj.fun, show.optimum = TRUE))
print(obj.fun)

des.n = 5
des.fun = lhs::randomLHS
des = generateDesign(des.n, par.set = getParamSet(obj.fun), des.fun)


surr.km_1 = makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE))

model_1 = generate_model(obj.fun, des, surr.km, control.iters=10, control.crit=makeMBOInfillCritEI())

# optional: define multi_iters here. default is c(1L, 2L, 10L)

run_1 = run_model(obj.fun=obj.fun, design=model_1$des, learner=surr.km, control=model_1$control,
                  multi_iters=10L)

results_1 = get_results(run_1)
results_1

```
## 2. CB, Random

```{r}
obj.fun = makeCosineMixtureFunction(1)
obj.fun = convertToMinimization(obj.fun)
print(autoplot(obj.fun, show.optimum = TRUE))
print(obj.fun)

des.n = 5
des.fun = lhs::randomLHS
des = generateDesign(des.n, par.set = getParamSet(obj.fun), des.fun)

surr.km = makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE))

model_3 = generate_model(obj.fun, des, surr.km, control.iters=10, control.crit=makeMBOInfillCritCB())


# optional: define multi_iters here. default is c(1L, 2L, 10L)

run_3 = run_model(obj.fun=obj.fun, design=model_3$des, learner=surr.km, control=model_3$control,
                  multi_iters=10L)

results_3 = get_results(run_3)
results_3
```

# Table 2: Kriging + Branin (2D)

## . EI, Random

```{r}
obj.fun = makeBraninFunction()
print(autoplot(obj.fun, show.optimum = TRUE))
print(obj.fun)

des.n = 5
des.fun = lhs::randomLHS
des = generateDesign(des.n, par.set = getParamSet(obj.fun), des.fun)

surr.km = makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE))

model_2 = generate_model(obj.fun, des, surr.km, control.iters=10, control.crit=makeMBOInfillCritEI())

# optional: define multi_iters here. default is c(1L, 2L, 10L)

run_2 = run_model(obj.fun=obj.fun, design=model_2$des, learner=surr.km, control=model_2$control,
                  multi_iters = 10L)
results_2 = get_results(run_2)
results_2

run_2$mbo.res$best.ind
```
