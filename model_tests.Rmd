---
title: "Model Comparison"
author: "Ellen Wei"
date: "2024-06-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Imports
```{r}
library(mlrMBO)
library(lhs)
library(smoof)
library(ggplot2)
library(DiceKriging)
library(gridExtra)
library(GGally)
```

1. Define objective function and its parameters using the package smoof.
  Cosine mixture function (1D), Branin (2D), Hartmann(6D)
  
2. Generate initial design (optional).
  LHS, Random, Uniform
  
3. Define mlr learner for surrogate model (optional).
  Kriging (default), Random Forest
  
4. Set up a MBO control object.

5. Start the optimization with run=mbo().

6. Visualize runs: exampleRun, plotExampleRun

## General function and parameters

```{r}

# Cosine Mixture function
fun.cosine = makeCosineMixtureFunction(1)
fun.cosine = convertToMinimization(fun.cosine)
print(autoplot(fun.cosine, show.optimum = TRUE))
print(fun.cosine)

# Number of run iterations
multi_iters = 10L
control_iters = 10L

  ### !!! NOTE: control_iters > multi_iters or things will not plot !!!

# Random LHS initial design parameters
des.n = 5

  # Random LHS Cosine mixture function generate
des.cosine_random = generateDesign(des.n, par.set = getParamSet(fun.cosine), randomLHS)

  # Maximin LHS Cosine mixture 
des.cosine_maximin = generateDesign(des.n, par.set = getParamSet(fun.cosine), maximinLHS)

# Kriging model (surrogate) constructor

surr.km = makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE))

```


```{r}
# separately generate obj.fun, surr.km (use makeLearner), des (LHS, random, uniform)


generate_model <- function(obj.fun, des, surr.km, control.iters=control.iters, control.crit){
  # Generates model but doesn't run or visualize
  # obj.fun: objective function ex. makeBraninFunction()
  # des required variables:
    # n: number of initial points
    # fun: initial design function ex. lhs::randomLHS
  # surr.km: surrogate model ex. makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE))
  
  # control: infill criteria
    # control.iters
    # control.crit: infill criteria ex. makeMBOInfillCritEI()
  
  #des = generateDesign(des.n, par.set = getParamSet(obj.fun), des.fun)
  des$y = apply(des, 1, obj.fun)
  control = makeMBOControl()
  control = setMBOControlTermination(control, iters = control.iters)
  control = setMBOControlInfill(control, crit = control.crit)
  
  return(list(obj.fun=obj.fun, learner=surr.km, des=des, control=control))
}

run_model <- function(model, show.info=FALSE, 
                      multi_iters= c(1L, 2L, 10L), pause=FALSE, points.per.dim=50) {
  # Runs model for _ iterations and displays plots
  
  run = exampleRun(fun=model$obj.fun, design=model$des, learner=model$learner, control=model$control,
                   show.info=show.info, points.per.dim=points.per.dim)
  plotExampleRun(run, iters=multi_iters, pause=pause)
  
  return(run)
} 

get_results <- function(run){
  return(as.data.frame(run$mbo.res$opt.path))
}

get_best <- function(run){
  return(run$mbo.res$best.ind)
}
```

# Table 1: Kriging+Cosine Mixture Function (1D)


## 1. EI, Random

```{r}

model_1 = generate_model(fun.cosine, des.cosine_random, surr.km, 
                         control.iters=control_iters, control.crit=makeMBOInfillCritEI())

# optional: define multi_iters here. default is c(1L, 2L, 10L)

run_1 = run_model(model=model_1, multi_iters=multi_iters)

results_1 = get_results(run_1)
results_1

```

## 2. CB, Random

```{r}

model_2 = generate_model(fun.cosine, des.cosine_random, surr.km,
                         control.iters=control_iters, control.crit=makeMBOInfillCritCB())


# optional: define multi_iters here. default is c(1L, 2L, 10L)
run_2 = run_model(model=model_2, multi_iters=multi_iters)

results_2 = get_results(run_2)
results_2
```


## 3. AEI, Random

```{r}
model_3 = generate_model(fun.cosine, des.cosine_random, surr.km,
                         control.iters=control_iters, control.crit=makeMBOInfillCritAEI())

# optional: define multi_iters here. default is c(1L, 2L, 10L)
run_3 = run_model(model=model_3, multi_iters=multi_iters)

results_3 = get_results(run_3)
results_3

```

## 4. EI, Maximin

```{r}

model_4 = generate_model(fun.cosine, des.cosine_maximin, surr.km, 
                         control.iters=control_iters, control.crit=makeMBOInfillCritEI())

# optional: define multi_iters here. default is c(1L, 2L, 10L)

run_4 = run_model(model=model_4, multi_iters=multi_iters)

results_4 = get_results(run_4)
results_4

```

## 5. CB, Maximin

```{r}

model_5 = generate_model(fun.cosine, des.cosine_maximin, surr.km,
                         control.iters=control_iters, control.crit=makeMBOInfillCritCB())


# optional: define multi_iters here. default is c(1L, 2L, 10L)
run_5 = run_model(model=model_5, multi_iters=multi_iters)

results_5 = get_results(run_5)
results_5

```


## 6. AEI, Maximin

```{r}
model_6 = generate_model(fun.cosine, des.cosine_maximin, surr.km,
                         control.iters=20, control.crit=makeMBOInfillCritAEI())

# optional: define multi_iters here. default is c(1L, 2L, 10L)
run_6 = run_model(model=model_6, multi_iters=20)

results_6 = get_results(run_6)
results_6

```



## 7. EI, Optimum


## 8. CB, Optimum


## 9. AEI, Optimum




# Table 2: Kriging + Branin (2D)

## . EI, Random

```{r}
obj.fun = makeBraninFunction()
print(autoplot(obj.fun, show.optimum = TRUE))
print(obj.fun)

des.n = 5
des.fun = lhs::randomLHS
des = generateDesign(des.n, par.set = getParamSet(obj.fun), des.fun)

surr.km = makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE))

model_2 = generate_model(obj.fun, des, surr.km, control.iters=10, control.crit=makeMBOInfillCritEI())

# optional: define multi_iters here. default is c(1L, 2L, 10L)

run_2 = run_model(obj.fun=obj.fun, design=model_2$des, learner=surr.km, control=model_2$control,
                  multi_iters = multi_iters)
results_2 = get_results(run_2)
results_2

run_2$mbo.res$best.ind
```
